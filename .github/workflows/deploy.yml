# =============================================
# VTG TOOL - CI/CD Pipeline (Chuáº©n Industry)
# =============================================
# Workflow: Build â†’ Push to Registry â†’ Deploy to Server
#
# Branches:
#   - main â†’ Build + Deploy to PRODUCTION
#   - uat  â†’ Build + Deploy to UAT
#   - PR   â†’ Build only (test)
#
# Server chá»‰ PULL images, khÃ´ng build, khÃ´ng cÃ³ source code

name: Build & Deploy

on:
  push:
    branches: [main, uat]
  pull_request:
    branches: [main, uat]

env:
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/vtgtool-be
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/vtgtool-fe

jobs:
  # ============================================
  # JOB 1: Build and Push Docker Images
  # ============================================
  build:
    name: ðŸ”¨ Build & Push Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine tags
        id: tags
        run: |
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "tag=uat" >> $GITHUB_OUTPUT
            echo "env=staging" >> $GITHUB_OUTPUT
          fi
          echo "sha=$SHA_SHORT" >> $GITHUB_OUTPUT

      # Build Backend
      - name: Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./packages/backend
          file: ./packages/backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ steps.tags.outputs.sha }}
            ${{ env.BACKEND_IMAGE }}:${{ steps.tags.outputs.tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Build Frontend
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./packages/frontend
          file: ./packages/frontend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ steps.tags.outputs.sha }}
            ${{ env.FRONTEND_IMAGE }}:${{ steps.tags.outputs.tag }}
          build-args: |
            VITE_API_URL=/api
          cache-from: type=gha
          cache-to: type=gha,mode=max

    outputs:
      sha: ${{ steps.tags.outputs.sha }}
      tag: ${{ steps.tags.outputs.tag }}
      env: ${{ steps.tags.outputs.env }}

  # ============================================
  # JOB 2: Deploy to UAT (uat branch)
  # ============================================
  deploy-uat:
    name: ðŸš€ Deploy to UAT
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/uat' && github.event_name == 'push'
    environment: uat
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ needs.build.outputs.sha }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
        with:
          host: ${{ secrets.UAT_SSH_HOST }}
          username: root
          key: ${{ secrets.UAT_SSH_KEY }}
          envs: IMAGE_TAG,BACKEND_IMAGE,FRONTEND_IMAGE
          script: |
            cd /opt/vtgtool

            # Update image tag
            sed -i "s|IMAGE_TAG=.*|IMAGE_TAG=$IMAGE_TAG|g" .env

            # Pull and restart (use docker-compose for compatibility)
            docker-compose pull
            docker-compose -f docker-compose.yml -f docker-compose.uat.yml up -d --remove-orphans
            docker image prune -f

            echo "âœ… UAT deployed: $IMAGE_TAG"

  # ============================================
  # JOB 3: Deploy to Production (main branch)
  # ============================================
  deploy-prod:
    name: ðŸš€ Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          IMAGE_TAG: ${{ needs.build.outputs.sha }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: root
          key: ${{ secrets.PROD_SSH_KEY }}
          envs: IMAGE_TAG,BACKEND_IMAGE,FRONTEND_IMAGE
          script: |
            cd /opt/vtgtool

            # Update image tag
            sed -i "s|IMAGE_TAG=.*|IMAGE_TAG=$IMAGE_TAG|g" .env

            # Pull and restart (zero-downtime, use docker-compose for compatibility)
            docker-compose pull
            docker-compose up -d --no-deps backend
            sleep 5
            docker-compose up -d --no-deps frontend
            docker image prune -f

            echo "âœ… Production deployed: $IMAGE_TAG"